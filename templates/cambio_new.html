<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{.Title}}</title>
  <style>
    :root {
      color-scheme: light;
      ----bg: #faf9f7;
      --card: #ffffff;
      --text: #2a2826;
      --muted: #6b6560;
      --primary: #e85d3c;
      --danger: #d64545;
      --border: #e8e4df;
      --info: #1f6feb;
    }

    * {
      box-sizing: border-box;
      font-family: "Inter", "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      padding: 24px;
    }

    /* Nuevo diseño de botones de navegación */
    .nav-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .nav-button {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
      border: 1px solid var(--primary);
      background: var(--card);
      color: var(--primary);
      cursor: pointer;
    }

    .nav-button:hover {
      background: var(--primary);
      color: var(--card);
    }

    .nav-button.active {
      background: var(--primary);
      color: var(--card);
    }

    .card {
      max-width: 900px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
      box-shadow: 0 12px 30px rgba(30, 41, 59, 0.08);
    }

    h1 {
      margin: 0 0 8px;
      font-size: 24px;
    }

    p {
      margin: 0 0 16px;
      color: var(--muted);
    }

    .alert {
      padding: 12px 16px;
      border-radius: 12px;
      background: #e8f1ff;
      border: 1px solid #c6dcff;
      color: #1f3c88;
      font-size: 14px;
      margin-bottom: 16px;
    }

    form {
      display: grid;
      gap: 18px;
    }

    label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
    }

    textarea {
      min-height: 110px;
      resize: vertical;
    }

    .row {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .section {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: grid;
      gap: 12px;
      background: #f9fafc;
    }

    .section h2 {
      margin: 0;
      font-size: 16px;
    }

    .multi-select {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: white;
      padding: 8px 12px;
    }

    .multi-select summary {
      list-style: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
      color: var(--text);
    }

    .multi-select summary::-webkit-details-marker {
      display: none;
    }

    .multi-select .summary-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .multi-select .options {
      margin-top: 10px;
      display: grid;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .multi-select .option {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text);
    }

    .multi-select input[type="checkbox"] {
      width: auto;
    }

    .selection-count {
      font-weight: 600;
      color: var(--info);
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
    }

    .error {
      color: var(--danger);
      font-size: 12px;
    }

    .is-hidden {
      display: none;
    }

    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button,
    a.button {
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    button.primary {
      background: var(--primary);
      color: white;
    }

    .secondary {
      background: #e7ebf6;
      color: #2a335a;
    }

    .note {
      font-size: 12px;
      color: var(--info);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="nav-buttons">
    <a href="/inventario" class="nav-button">Volver a inventario</a>
    <a href="/venta/new" class="nav-button">Registrar venta</a>
    <a href="/cambio/new" class="nav-button active">Registrar cambio</a>
    <a href="/csv/template" class="nav-button" target="_blank">Plantilla CSV</a>
    <a href="/csv/export" class="nav-button" target="_blank">Exportaciones CSV</a>
  </div>

  <div class="card">
    <h1>{{.Title}}</h1>
    <p>Define el flujo de cambio desde inventario, sin registrar dinero.</p>

    <div class="alert">
      Este flujo solo registra el movimiento de cambio. Si hay dinero de por medio, utiliza el flujo de ventas.
    </div>

    <form action="/cambio" method="POST">
      <div class="row">
        <div>
          <label for="producto_id">Producto saliente</label>
          <select id="producto_id" name="producto_id">
            {{range .Productos}}
              <option value="{{.ID}}" {{if eq $.ProductoID .ID}}selected{{end}}>{{.Name}} ({{.ID}})</option>
            {{end}}
          </select>
          {{with index .Errors "producto_id"}}
            <div class="error">{{.}}</div>
          {{end}}
        </div>
        <div>
          <label for="persona_del_cambio">Persona del cambio</label>
          <input id="persona_del_cambio" name="persona_del_cambio" type="text" value="{{.PersonaCambio}}" placeholder="Nombre de quien solicita o recibe" />
          {{with index .Errors "persona_del_cambio"}}
            <div class="error">{{.}}</div>
          {{end}}
        </div>
      </div>

      <div class="section">
        <h2>Unidades salientes (DISPONIBLE → CAMBIO)</h2>
        <div class="hint">Selecciona una o varias unidades disponibles. Disponible: {{len .Unidades}} unidades.</div>
        {{if .Unidades}}
          <details class="multi-select" data-multi-select>
            <summary>
              <span>Seleccionar unidades</span>
              <span class="summary-meta"><span class="selection-count" data-selection-count>0</span> de {{len .Unidades}} seleccionadas</span>
            </summary>
            <div class="options" role="listbox" aria-label="Unidades disponibles">
              {{range .Unidades}}
                <label class="option">
                  <input type="checkbox" name="salientes" value="{{.ID}}" {{if index $.SalientesMap .ID}}checked{{end}} />
                  {{.ID}}
                </label>
              {{end}}
            </div>
          </details>
        {{else}}
          <div class="error">No hay unidades disponibles para este producto.</div>
        {{end}}
        {{with index .Errors "salientes"}}
          <div class="error">{{.}}</div>
        {{end}}
      </div>

      <div class="section">
        <h2>Entrantes (se crean como DISPONIBLE)</h2>
        <div>
          <label for="incoming_mode">Tipo de entrada</label>
          <select id="incoming_mode" name="incoming_mode">
            <option value="existing" {{if or (eq .IncomingMode "") (eq .IncomingMode "existing")}}selected{{end}}>Producto existente</option>
            <option value="new" {{if eq .IncomingMode "new"}}selected{{end}}>Producto nuevo</option>
          </select>
          <div class="hint">Elige si entra un producto existente o uno nuevo.</div>
        </div>
        {{with index .Errors "incoming_mode"}}
          <div class="error">{{.}}</div>
        {{end}}

        <div class="row" id="incoming_existing_fields">
          <div>
            <label for="incoming_existing_id">Producto entrante</label>
            <select id="incoming_existing_id" name="incoming_existing_id">
              {{range .Productos}}
                <option value="{{.ID}}" {{if eq $.IncomingExistingID .ID}}selected{{end}}>{{.Name}} ({{.ID}})</option>
              {{end}}
            </select>
            {{with index .Errors "incoming_existing_id"}}
              <div class="error">{{.}}</div>
            {{end}}
          </div>
          <div>
            <label for="incoming_existing_qty">Cantidad entrante</label>
            <input id="incoming_existing_qty" name="incoming_existing_qty" type="number" min="1" value="{{.IncomingExistingQty}}" />
            {{with index .Errors "incoming_existing_qty"}}
              <div class="error">{{.}}</div>
            {{end}}
          </div>
        </div>

        <div class="row" id="incoming_new_fields">
          <div>
            <label for="incoming_new_sku">SKU nuevo</label>
            <input id="incoming_new_sku" name="incoming_new_sku" type="text" value="{{.IncomingNewSKU}}" placeholder="SKU o código interno" />
            {{with index .Errors "incoming_new_sku"}}
              <div class="error">{{.}}</div>
            {{end}}
          </div>
          <div>
            <label for="incoming_new_name">Nombre del producto nuevo</label>
            <input id="incoming_new_name" name="incoming_new_name" type="text" value="{{.IncomingNewName}}" placeholder="Nombre comercial" />
            {{with index .Errors "incoming_new_name"}}
              <div class="error">{{.}}</div>
            {{end}}
          </div>
        </div>

        <div class="row" id="incoming_new_qty_fields">
          <div>
            <label for="incoming_new_line">Línea</label>
            <input id="incoming_new_line" name="incoming_new_line" type="text" value="{{.IncomingNewLine}}" placeholder="Ej. Dermocosmética" />
          </div>
          <div>
            <label for="incoming_new_qty">Cantidad entrante</label>
            <input id="incoming_new_qty" name="incoming_new_qty" type="number" min="1" value="{{.IncomingNewQty}}" />
            {{with index .Errors "incoming_new_qty"}}
              <div class="error">{{.}}</div>
            {{end}}
          </div>
        </div>
      </div>

      <div>
        <label for="notas">Notas</label>
        <textarea id="notas" name="notas" placeholder="Observaciones del cambio">{{.Notas}}</textarea>
      </div>

      <div class="note">No se registra dinero en este flujo. Usa Venta si hay pago adicional.</div>

      <div class="actions">
        <button class="primary" type="submit">Confirmar cambio</button>
        <a class="button secondary" href="/inventario">Volver a inventario</a>
      </div>
    </form>
  </div>
  <script>
    const incomingModeSelect = document.querySelector('#incoming_mode');
    const existingFields = document.querySelectorAll('#incoming_existing_id, #incoming_existing_qty');
    const newFields = document.querySelectorAll('#incoming_new_sku, #incoming_new_name, #incoming_new_line, #incoming_new_qty');
    const existingFieldGroup = document.querySelector('#incoming_existing_fields');
    const newFieldGroup = document.querySelector('#incoming_new_fields');
    const newQtyFieldGroup = document.querySelector('#incoming_new_qty_fields');
    const multiSelect = document.querySelector('[data-multi-select]');
    const selectionCount = document.querySelector('[data-selection-count]');

    const updateSelectionCount = () => {
      if (!multiSelect || !selectionCount) return;
      const checked = multiSelect.querySelectorAll('input[type="checkbox"]:checked').length;
      selectionCount.textContent = checked;
    };

    const updateIncomingMode = () => {
      const mode = incomingModeSelect ? incomingModeSelect.value : "existing";
      existingFields.forEach((field) => field.toggleAttribute("disabled", mode !== "existing"));
      newFields.forEach((field) => field.toggleAttribute("disabled", mode !== "new"));
      if (existingFieldGroup) {
        existingFieldGroup.classList.toggle("is-hidden", mode !== "existing");
      }
      if (newFieldGroup) {
        newFieldGroup.classList.toggle("is-hidden", mode !== "new");
      }
      if (newQtyFieldGroup) {
        newQtyFieldGroup.classList.toggle("is-hidden", mode !== "new");
      }
    };

    if (incomingModeSelect) {
      incomingModeSelect.addEventListener("change", updateIncomingMode);
    }
    updateIncomingMode();
    if (multiSelect) {
      multiSelect.addEventListener("change", updateSelectionCount);
      updateSelectionCount();
    }
  </script>
</body>
</html>
