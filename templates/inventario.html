<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{.Title}}</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #faf9f7;
      --card: #ffffff;
      --text: #2a2826;
      --muted: #6b6560;
      --primary: #e85d3c;
      --success: #2d9d78;
      --warning: #f59e42;
      --danger: #d64545;
      --border: #e8e4df;
    }

    * {
      box-sizing: border-box;
      font-family: "Inter", "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .page-content {
      padding: 16px 32px 32px;
    }

    .global-banner {
      background: #f47a24;
      padding: 6px 32px;
    }

    .banner-logos {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .logo-placeholder {
      height: 22px;
      min-width: 76px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px dashed rgba(255, 255, 255, 0.7);
      color: #ffffff;
      font-size: 11px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.2);
    }

    .page-header {
      padding: 16px 32px 8px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .page-header h1 {
      margin: 0;
      font-size: 24px;
    }

    .page-header p {
      margin: 0;
      color: var(--muted);
    }

    /* Nuevo diseño de botones de navegación */
    .nav-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .nav-button {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
      border: 1px solid var(--primary);
      background: var(--card);
      color: var(--primary);
      cursor: pointer;
    }

    .nav-button:hover {
      background: var(--primary);
      color: var(--card);
    }

    .nav-button.active {
      background: var(--primary);
      color: var(--card);
    }

    .nav-button.primary {
      background: var(--primary);
      color: var(--card);
    }

    .nav-button.primary:hover {
      background: #d84a2b;
    }

    .filters {
      margin: 16px 32px;
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      border: 1px solid var(--border);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }

    select,
    input[type="search"],
    input[type="number"] {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .flash {
      margin-top: 16px;
      background: #e9f7f1;
      color: #1a6b4b;
      border: 1px solid #bde4d2;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
    }

    main {
      padding: 0 32px 32px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    thead {
      background: #eef1f8;
      text-align: left;
    }

    th,
    td {
      padding: 12px 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .status {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status.available {
      background: #e9f7f1;
      color: var(--success);
    }

    .status.sold {
      background: #ffeef0;
      color: var(--danger);
    }

    .status.swapped {
      background: #fff4e1;
      color: var(--warning);
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .actions input {
      width: 72px;
    }

    button {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    button.primary {
      background: var(--primary);
      color: white;
    }

    button.secondary {
      background: #e7ebf6;
      color: #2a335a;
    }

    button.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .menu {
      position: relative;
      display: inline-flex;
      justify-content: flex-end;
      width: 100%;
    }

    .menu-panel {
      position: absolute;
      right: 0;
      top: calc(100% + 6px);
      display: none;
      min-width: 190px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
      padding: 6px;
      z-index: 20;
    }

    .menu-panel.open {
      display: grid;
      gap: 4px;
    }

    .menu-panel button {
      width: 100%;
      text-align: left;
      background: #f6f7fb;
      color: #2a335a;
    }

    .product-name {
      font-weight: 600;
      color: #25304d;
      cursor: pointer;
    }

    .units-panel {
      background: #f9fafc;
      padding: 12px 16px 20px;
    }

    .units-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .units-header h4 {
      margin: 0;
    }

    .fifo-note {
      font-size: 12px;
      color: var(--muted);
    }

    .units-table th,
    .units-table td {
      font-size: 12px;
      padding: 8px 10px;
    }

    .unit-tag {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e7efff;
      color: #2054c6;
    }

    .summary {
      margin: 0 32px 16px;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .summary-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-card h3 {
      margin: 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }

    .summary-card span {
      font-size: 20px;
      font-weight: 700;
    }
  </style>
</head>
<body>
  {{template "header" .}}
  <div class="page-content">
    {{if .Flash}}
      <div class="flash">{{.Flash}}</div>
    {{end}}
    <!-- Estado - Sección de filtros -->
    <section class="filters">
    <div class="filter-group">
      <label for="statusFilter">Estado</label>
      <select id="statusFilter">
        <option value="all">Todos</option>
        <option value="available">Disponible</option>
        <option value="sold">Vendido</option>
        <option value="swapped">Cambio</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="lineFilter">Línea</label>
      <select id="lineFilter">
        <option value="all">Todas</option>
        <option value="Nutrición">Nutrición</option>
        <option value="Dermocosmética">Dermocosmética</option>
        <option value="Pediatría">Pediatría</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="searchFilter">Búsqueda</label>
      <input id="searchFilter" type="search" placeholder="Nombre o SKU" />
    </div>
    <div class="filter-group">
      <label>Caducidad próxima</label>
      <div class="toggle">
        <input id="expiryToggle" type="checkbox" />
        <span>Mostrar próximos 45 días</span>
      </div>
    </div>
    </section>

  <section id="summary" class="summary" aria-live="polite"></section>

  <main>
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Línea</th>
          <th>Estado</th>
          <th>Stock disponible</th>
          <th>Acciones rápidas</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>
    </table>
  </main>

  <script>
    const products = [
      {{- range .Products }}
      {
        id: "{{js .ID}}",
        name: "{{js .Name}}",
        line: "{{js .Line}}",
        statusClass: "{{js .EstadoClass}}",
        statusLabel: "{{js .EstadoLabel}}",
        available: {{.Disponible}},
        units: [
          {{- range .Unidades }}
          {
            id: "{{js .ID}}",
            created: "{{js .CreadoEn}}",
            expires: "{{js .Caducidad}}",
            statusClass: "{{js .EstadoClass}}",
            statusLabel: "{{js .Estado}}",
            fifo: "{{js .FIFO}}"
          },
          {{- end }}
        ]
      },
      {{- end }}
    ];

    const statusFilter = document.getElementById("statusFilter");
    const lineFilter = document.getElementById("lineFilter");
    const searchFilter = document.getElementById("searchFilter");
    const expiryToggle = document.getElementById("expiryToggle");
    const productTable = document.getElementById("productTable");
    const summary = document.getElementById("summary");
    const downloadTemplateButton = document.getElementById("download-template");
    const uploadInput = document.getElementById("csv-upload");
    const processButton = document.getElementById("process-csv");
    const uploadStatus = document.getElementById("upload-status");
    const uploadPreviewBody = document.getElementById("upload-preview-body");
    const movementLog = document.getElementById("movement-log");
    const rangeStart = document.getElementById("range-start");
    const rangeEnd = document.getElementById("range-end");
    const exportInventoryAggregateButton = document.getElementById("export-inventory-aggregate");
    const exportInventoryUnitsButton = document.getElementById("export-inventory-units");
    const exportSalesButton = document.getElementById("export-sales");
    const exportChangesButton = document.getElementById("export-changes");

    const formatDate = (value) => new Date(value).toLocaleDateString("es-ES");
    const formatOptionalDate = (value) => {
      if (!value) return "-";
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) return "-";
      return parsed.toLocaleDateString("es-ES");
    };
    const formatDateISO = (value) => new Date(value).toISOString().slice(0, 10);
    const statusLabels = {
      available: "Disponible",
      sold: "Vendido",
      swapped: "Cambio",
      Disponible: "Disponible",
      Vendida: "Vendido",
      Vendido: "Vendido",
      Cambio: "Cambio"
    };
    const statusLabel = (status) => statusLabels[status] || status;

    const updateSummary = (visibleProducts) => {
      if (!summary) {
        console.warn("Resumen no disponible: falta el contenedor #summary.");
        return;
      }
      const totalProducts = visibleProducts.length;
      const totalUnits = visibleProducts.reduce((acc, product) => acc + product.available, 0);
      const expiringUnits = visibleProducts.reduce(
        (acc, product) => acc + product.units.filter((unit) => isExpiringSoon(unit.expires)).length,
        0
      );

      summary.innerHTML = `
        <div class="summary-card">
          <h3>Productos visibles</h3>
          <span>${totalProducts}</span>
        </div>
        <div class="summary-card">
          <h3>Unidades disponibles</h3>
          <span>${totalUnits}</span>
        </div>
        <div class="summary-card">
          <h3>Próximos a caducar</h3>
          <span>${expiringUnits}</span>
        </div>
      `;
    };

    const isExpiringSoon = (dateString) => {
      if (!dateString) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const expiry = new Date(dateString);
      if (Number.isNaN(expiry.getTime())) return false;
      expiry.setHours(0, 0, 0, 0);
      const diffDays = (expiry - today) / (1000 * 60 * 60 * 24);
      return diffDays >= 0 && diffDays <= 45;
    };

    const applyFilters = () => {
      if (!statusFilter || !lineFilter || !searchFilter || !expiryToggle) {
        console.warn("Filtros no disponibles: faltan controles de filtro en el DOM.");
        return;
      }
      const statusValue = statusFilter.value;
      const lineValue = lineFilter.value;
      const query = searchFilter.value.toLowerCase();
      const expiryOnly = expiryToggle.checked;

      const filtered = products.filter((product) => {
        const matchesStatus = statusValue === "all" || product.statusClass === statusValue;
        const matchesLine = lineValue === "all" || product.line === lineValue;
        const matchesSearch =
          product.name.toLowerCase().includes(query) || product.id.toLowerCase().includes(query);
        const matchesExpiry = !expiryOnly || product.units.some((unit) => isExpiringSoon(unit.expires));

        return matchesStatus && matchesLine && matchesSearch && matchesExpiry;
      });

      renderTable(filtered);
      updateSummary(filtered);
    };

    const renderTable = (items) => {
      if (!productTable) {
        console.warn("Tabla de productos no disponible: falta #productTable.");
        return;
      }
      productTable.innerHTML = "";

      items.forEach((product) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <div class="product-name" data-product="${product.id}">${product.name}</div>
            <div class="fifo-note">SKU ${product.id} · FIFO: ${product.available} unidades disponibles</div>
          </td>
          <td>${product.line}</td>
          <td><span class="status ${product.statusClass}">${statusLabel(product.statusLabel)}</span></td>
          <td><strong>${product.available}</strong></td>
          <td>
            <div class="actions">
              <input type="number" min="1" max="${Math.max(product.available, 1)}" value="1" data-qty="${product.id}" />
              <button class="primary" data-action="sell" data-product="${product.id}">Vender</button>
              <button class="secondary" data-action="swap" data-product="${product.id}">Cambio</button>
            </div>
          </td>
          <td>
            <div class="menu">
              <button class="ghost" data-menu="${product.id}">⋮</button>
              <div class="menu-panel" id="menu-${product.id}">
                <button>Reservar unidades</button>
                <button>Registrar daño</button>
                <button>Ver historial</button>
              </div>
            </div>
          </td>
        `;

        productTable.appendChild(row);

        const unitsRow = document.createElement("tr");
        unitsRow.innerHTML = `
          <td colspan="6" class="units-panel" id="units-${product.id}" style="display: none;">
            <div class="units-header">
              <h4>Unidades del producto</h4>
              <span class="fifo-note">Auditoría por lote · Selección FIFO al vender</span>
            </div>
            <table class="units-table" aria-label="Unidades del producto">
              <thead>
                <tr>
                  <th>ID unidad</th>
                  <th>Creado</th>
                  <th>Caducidad</th>
                  <th>Ubicación</th>
                  <th>Estado</th>
                  <th>FIFO</th>
                </tr>
              </thead>
              <tbody>
                ${product.units
                  .map((unit, index) => {
                    const fifoOrder = unit.fifo || (unit.statusClass === "available" ? index + 1 : "-");
                    return `
                      <tr>
                        <td>${unit.id}</td>
                        <td>${formatOptionalDate(unit.created)}</td>
                        <td>${formatOptionalDate(unit.expires)}</td>
                        <td>-</td>
                        <td>${statusLabel(unit.statusLabel)}</td>
                        <td><span class="unit-tag">${fifoOrder}</span></td>
                      </tr>
                    `;
                  })
                  .join("")}
              </tbody>
            </table>
          </td>
        </tr>
        `;

        productTable.appendChild(unitsRow);
      });
    };

    renderTable(products);
    updateSummary(products);
    if (statusFilter && lineFilter && searchFilter && expiryToggle) {
      [statusFilter, lineFilter, searchFilter, expiryToggle].forEach((input) =>
        input.addEventListener("change", applyFilters)
      );
      searchFilter.addEventListener("input", applyFilters);
    } else {
      console.warn("Listeners de filtros no registrados por controles faltantes.");
    }
  </script>

  <script>
    document.addEventListener("click", (event) => {
      const menuButton = event.target.closest("button[data-menu]");
      if (menuButton) {
        const menuId = menuButton.dataset.menu;
        const panel = document.getElementById(`menu-${menuId}`);
        if (!panel) return;
        const willOpen = !panel.classList.contains("open");
        document.querySelectorAll(".menu-panel.open").forEach((openPanel) => openPanel.classList.remove("open"));
        if (willOpen) {
          panel.classList.add("open");
        }
        return;
      }

      if (!event.target.closest(".menu")) {
        document.querySelectorAll(".menu-panel.open").forEach((panel) => panel.classList.remove("open"));
      }

      const actionButton = event.target.closest("button[data-action]");
      if (actionButton) {
        const productId = actionButton.dataset.product;
        const action = actionButton.dataset.action;
        const qtyInput = document.querySelector(`input[data-qty="${productId}"]`);
        const quantity = parseInt(qtyInput?.value || "1", 10);
        const maxQty = parseInt(qtyInput?.max || "0", 10);

        if (!productId || Number.isNaN(quantity) || quantity < 1 || (maxQty >= 1 && quantity > maxQty)) {
          return;
        }

        const params = new URLSearchParams({
          producto_id: productId,
          cantidad: String(quantity)
        });

        if (action === "sell") {
          window.location.href = `/venta/new?${params.toString()}`;
          return;
        }

        if (action === "swap") {
          window.location.href = `/cambio/new?${params.toString()}`;
          return;
        }
      }

      const productTrigger = event.target.closest(".product-name");
      if (!productTrigger) return;
      const productId = productTrigger.dataset.product;
      const panel = document.getElementById(`units-${productId}`);
      if (!panel) return;
      panel.style.display = panel.style.display === "none" ? "table-cell" : "none";
    });
  </script>
</body>
</html>
