<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{.Title}}</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #faf9f7;
      --card: #ffffff;
      --text: #2a2826;
      --muted: #6b6560;
      --primary: #e85d3c;
      --success: #2d9d78;
      --warning: #f59e42;
      --danger: #d64545;
      --border: #e8e4df;
    }

    * {
      box-sizing: border-box;
      font-family: "Inter", "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 24px 32px 8px;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
    }

    header p {
      margin: 8px 0 0;
      color: var(--muted);
    }

    /* Nuevo diseño de botones de navegación */
    .nav-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .nav-button {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
      border: 1px solid var(--primary);
      background: var(--card);
      color: var(--primary);
      cursor: pointer;
    }

    .nav-button:hover {
      background: var(--primary);
      color: var(--card);
    }

    .nav-button.active {
      background: var(--primary);
      color: var(--card);
    }

    .nav-button.primary {
      background: var(--primary);
      color: var(--card);
    }

    .nav-button.primary:hover {
      background: #d84a2b;
    }

    header nav a {
      text-decoration: none;
      color: var(--primary);
      font-size: 13px;
      font-weight: 600;
    }

    .filters {
      margin: 16px 32px;
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      border: 1px solid var(--border);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }

    select,
    input[type="search"],
    input[type="number"] {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .flash {
      margin-top: 16px;
      background: #e9f7f1;
      color: #1a6b4b;
      border: 1px solid #bde4d2;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
    }

    main {
      padding: 0 32px 32px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    thead {
      background: #eef1f8;
      text-align: left;
    }

    th,
    td {
      padding: 12px 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .status {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status.available {
      background: #e9f7f1;
      color: var(--success);
    }

    .status.sold {
      background: #ffeef0;
      color: var(--danger);
    }

    .status.swapped {
      background: #fff4e1;
      color: var(--warning);
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .actions input {
      width: 72px;
    }

    button {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    button.primary {
      background: var(--primary);
      color: white;
    }

    button.secondary {
      background: #e7ebf6;
      color: #2a335a;
    }

    button.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .product-name {
      font-weight: 600;
      color: #25304d;
      cursor: pointer;
    }

    .units-panel {
      background: #f9fafc;
      padding: 12px 16px 20px;
    }

    .units-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .units-header h4 {
      margin: 0;
    }

    .fifo-note {
      font-size: 12px;
      color: var(--muted);
    }

    .units-table th,
    .units-table td {
      font-size: 12px;
      padding: 8px 10px;
    }

    .unit-tag {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e7efff;
      color: #2054c6;
    }
  </style>
</head>
<body>
  <header>
    <h1>{{.Title}}</h1>
    <p>{{.Subtitle}}</p>
    <div class="nav-buttons">
      <a href="/dashboard" class="nav-button">Ver dashboard</a>
      <a href="/venta/new" class="nav-button">Registrar venta</a>
      <a href="/cambio/new" class="nav-button">Registrar cambio</a>
      <a href="/csv/template" class="nav-button" target="_blank">Plantilla CSV</a>
      <a href="/csv/export" class="nav-button" target="_blank">Exportaciones CSV</a>
    </div>
    {{if .Flash}}
      <div class="flash">{{.Flash}}</div>
    {{end}}
  </header>

  <!-- Estado - Sección de filtros -->
  <section class="filters">
    <div class="filter-group">
      <label for="statusFilter">Estado</label>
      <select id="statusFilter">
        <option value="all">Todos</option>
        <option value="available">Available</option>
        <option value="sold">Sold</option>
        <option value="swapped">Swapped</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="lineFilter">Línea</label>
      <select id="lineFilter">
        <option value="all">Todas</option>
        <option value="Nutrición">Nutrición</option>
        <option value="Dermocosmética">Dermocosmética</option>
        <option value="Pediatría">Pediatría</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="searchFilter">Búsqueda</label>
      <input id="searchFilter" type="search" placeholder="Nombre o SKU" />
    </div>
    <div class="filter-group">
      <label>Caducidad próxima</label>
      <div class="toggle">
        <input id="expiryToggle" type="checkbox" />
        <span>Mostrar próximos 45 días</span>
      </div>
    </div>
  </section>

  <main>
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Línea</th>
          <th>Estado</th>
          <th>Stock disponible</th>
          <th>Acciones rápidas</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {{range .Products}}
        <tr>
          <td>
            <div class="product-name" data-product="{{.ID}}">{{.Name}}</div>
            <div class="fifo-note">SKU {{.ID}} · FIFO: {{.Disponible}} unidades disponibles</div>
          </td>
          <td>{{.Line}}</td>
          <td><span class="status {{.EstadoClass}}">{{.EstadoLabel}}</span></td>
          <td><strong>{{.Disponible}}</strong></td>
          <td>
            <form class="actions" method="GET">
              <input type="hidden" name="producto_id" value="{{.ID}}" />
              <input type="number" name="cantidad" min="1" max="{{.Disponible}}" value="1" {{if .DisabledSale}}disabled{{end}} />
              <button class="primary" type="submit" formaction="/venta/new" {{if .DisabledSale}}disabled{{end}}>Vender</button>
              <button class="secondary" type="submit" formaction="/cambio/new" {{if .DisabledSale}}disabled{{end}}>Cambio</button>
            </form>
          </td>
          <td></td>
        </tr>
        <tr>
          <td colspan="6" class="units-panel" id="units-{{.ID}}" style="display: none;">
            <div class="units-header">
              <h4>Unidades del producto</h4>
              <span class="fifo-note">Auditoría por lote · Selección FIFO al vender</span>
            </div>
            <table class="units-table" aria-label="Unidades de {{.Name}}">
              <thead>
                <tr>
                  <th>ID unidad</th>
                  <th>Creado</th>
                  <th>Estado</th>
                  <th>FIFO</th>
                </tr>
              </thead>
              <tbody>
                {{range .Unidades}}
                <tr>
                  <td>{{.ID}}</td>
                  <td>{{.CreadoEn}}</td>
                  <td><span class="status {{.EstadoClass}}">{{.Estado}}</span></td>
                  <td><span class="unit-tag">{{.FIFO}}</span></td>
                </tr>
                {{end}}
              </tbody>
            </table>
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </main>

  <script>
    document.addEventListener("click", (event) => {
      const productTrigger = event.target.closest(".product-name");
      if (!productTrigger) return;
      const productId = productTrigger.dataset.product;
      const panel = document.getElementById(`units-${productId}`);
      panel.style.display = panel.style.display === "none" ? "table-cell" : "none";
    });
  </script>
</body>
</html>
