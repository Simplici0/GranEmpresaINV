<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{.Title}}</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f7f5f2;
      --card: #ffffff;
      --text: #26221f;
      --muted: #6f6a65;
      --primary: #e85d3c;
      --primary-strong: #cf4528;
      --primary-soft: #fff1e6;
      --success: #2d9d78;
      --warning: #f59e42;
      --danger: #d64545;
      --border: #e6dfd8;
      --shadow-soft: 0 8px 18px rgba(18, 23, 38, 0.08);
    }

    * {
      box-sizing: border-box;
      font-family: "Inter", "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .page-content {
      padding: 24px 32px 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .global-banner {
      background: #f47a24;
      padding: 10px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .banner-logos {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .logo-placeholder {
      height: 26px;
      min-width: 76px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px dashed rgba(255, 255, 255, 0.7);
      color: #ffffff;
      font-size: 11px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.2);
    }

    .page-header {
      padding: 18px 32px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }

    .page-header h1 {
      margin: 0;
      font-size: 24px;
    }

    .page-header p {
      margin: 0;
      color: var(--muted);
    }

    /* Nuevo diseño de botones de navegación */
    .nav-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 8px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow-soft);
      width: fit-content;
    }

    .nav-button {
      display: inline-flex;
      padding: 8px 14px;
      border-radius: 999px;
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      background: var(--primary-soft);
      color: var(--primary);
      cursor: pointer;
    }

    .nav-button:hover {
      background: var(--primary);
      color: #ffffff;
    }

    .nav-button.active {
      background: var(--primary);
      color: #ffffff;
    }

    .filters {
      margin: 0;
      background: var(--card);
      border-radius: 18px;
      padding: 20px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      transition: box-shadow 0.3s ease;
    }

    .filters:hover {
      box-shadow: 0 10px 24px rgba(18, 23, 38, 0.1);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    select,
    input[type="search"],
    input[type="number"] {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: #ffffff;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    select:hover,
    input[type="search"]:hover,
    input[type="number"]:hover {
      border-color: rgba(232, 93, 60, 0.3);
    }

    select:focus,
    input[type="search"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(232, 93, 60, 0.16);
      transform: translateY(-1px);
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .flash {
      margin-top: 16px;
      background: #eaf7f1;
      color: #1f6b4f;
      border: 1px solid #c7e6d7;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
    }

    main {
      padding: 0;
    }

    .table-wrap {
      overflow-x: auto;
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      background: var(--card);
    }

    table {
      width: 100%;
      min-width: 920px;
      border-collapse: collapse;
      background: transparent;
    }

    thead {
      background: #f9f7f4;
      text-align: left;
    }

    th,
    td {
      padding: 12px 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr {
      transition: background-color 0.2s ease;
    }

    tbody tr:hover {
      background-color: #fafaf9;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .status {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid transparent;
    }

    .status.available {
      background: #e9f7f1;
      color: #1f7a5f;
      border-color: #bfe7d6;
    }

    .status.sold {
      background: #ffecef;
      color: #b73a3a;
      border-color: #f5c6cf;
    }

    .status.swapped {
      background: #fff4e1;
      color: #b36a1c;
      border-color: #f2d1a5;
    }

    .status.reserved {
      background: #e8f1ff;
      color: #1f3c88;
      border-color: #c6dcff;
    }

    .status.damaged {
      background: #fff0f0;
      color: #9a2f2f;
      border-color: #f5c6cf;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .actions input {
      width: 72px;
    }

    button {
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      background: var(--card);
      color: var(--text);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    button:hover {
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary) 0%, #d85038 100%);
      border-color: var(--primary);
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(232, 93, 60, 0.2);
    }

    button.primary:hover {
      box-shadow: 0 4px 12px rgba(232, 93, 60, 0.3);
      transform: translateY(-2px);
    }

    button.secondary {
      background: var(--primary-soft);
      color: var(--primary);
      border-color: #f2c6a8;
    }

    button.secondary:hover {
      background: #ffe4d1;
      border-color: var(--primary);
    }

    button.ghost {
      background: transparent;
      color: var(--muted);
    }

    button.ghost:hover {
      background: #f9f7f4;
      color: var(--text);
    }

    .menu {
      position: relative;
      display: inline-flex;
      justify-content: flex-end;
      width: 100%;
    }

    .menu-panel {
      position: fixed;
      left: 0;
      top: 0;
      display: none;
      min-width: 190px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
      padding: 6px;
      z-index: 60;
    }

    .menu-panel.open {
      display: grid;
      gap: 4px;
    }

    .menu-panel button {
      width: 100%;
      text-align: left;
      background: #f6f7fb;
      color: #2a335a;
    }

    .product-name {
      font-weight: 600;
      color: #25304d;
      cursor: pointer;
      transition: color 0.2s ease;
      position: relative;
      display: inline-block;
    }

    .product-name:hover {
      color: var(--primary);
    }

    .product-name::after {
      content: '▼';
      margin-left: 6px;
      font-size: 10px;
      opacity: 0.5;
      transition: transform 0.2s ease;
    }

    .product-name:hover::after {
      transform: translateY(2px);
    }

    .units-panel {
      background: #fbfaf8;
      padding: 12px 16px 20px;
    }

    .units-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .units-header h4 {
      margin: 0;
    }

    .fifo-note {
      font-size: 12px;
      color: var(--muted);
    }

    .units-table th,
    .units-table td {
      font-size: 12px;
      padding: 8px 10px;
    }

    .unit-tag {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eef2ff;
      color: #3a4bb3;
    }

    .summary {
      margin: 16px 0;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .summary-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: var(--shadow-soft);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, var(--primary) 0%, #f59e42 100%);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .summary-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 24px rgba(18, 23, 38, 0.12);
    }

    .summary-card:hover::before {
      transform: scaleX(1);
    }

    .summary-card h3 {
      margin: 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }

    .summary-card span {
      font-size: 20px;
      font-weight: 700;
    }

    /* Modal (historial) */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(18, 23, 38, 0.46);
      backdrop-filter: blur(4px);
      z-index: 100;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      width: min(860px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 18px 42px rgba(18, 23, 38, 0.22);
      overflow: hidden;
      transform: translateY(6px);
      opacity: 0;
      animation: modalIn 0.18s ease-out forwards;
    }

    @keyframes modalIn {
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #fbfaf8 100%);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.01em;
    }

    .modal-subtitle {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .modal-close {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--muted);
      font-weight: 800;
      line-height: 1;
      padding: 0;
    }

    .modal-close:hover {
      background: #f9f7f4;
      color: var(--text);
    }

    .modal-body {
      padding: 14px 18px 18px;
      display: grid;
      gap: 12px;
    }

    .modal-loading,
    .modal-empty {
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fbfaf8;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
    }

    .modal table {
      min-width: 0;
    }

    .move-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid transparent;
    }

    .move-tag.venta {
      background: #ffecef;
      color: #b73a3a;
      border-color: #f5c6cf;
    }

    .move-tag.reservar {
      background: #e8f1ff;
      color: #1f3c88;
      border-color: #c6dcff;
    }

    .move-tag.dano {
      background: #fff0f0;
      color: #9a2f2f;
      border-color: #f5c6cf;
    }

    .move-tag.cambio_salida {
      background: #fff4e1;
      color: #b36a1c;
      border-color: #f2d1a5;
    }

    .modal textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: #ffffff;
      min-height: 92px;
      resize: vertical;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal textarea:hover {
      border-color: rgba(232, 93, 60, 0.3);
    }

    .modal textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(232, 93, 60, 0.16);
      transform: translateY(-1px);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      padding-top: 6px;
    }

    .modal-error {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid #f5c6cf;
      background: #ffecef;
      color: #b73a3a;
      font-size: 14px;
      font-weight: 700;
    }

    .modal-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }

    .modal-row {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      align-items: end;
    }
  </style>
</head>
<body>
  {{template "header" .}}
  <div class="page-content">
    {{if .Flash}}
      <div class="flash">{{.Flash}}</div>
    {{end}}
    <!-- Estado - Sección de filtros -->
    <section class="filters">
    <div class="filter-group">
      <label for="statusFilter">Estado</label>
      <select id="statusFilter">
        <option value="all">Todos</option>
        <option value="available">Disponible</option>
        <option value="reserved">Reservado</option>
        <option value="sold">Vendido</option>
        <option value="swapped">Cambio</option>
        <option value="damaged">Dañado</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="lineFilter">Línea</label>
      <select id="lineFilter">
        <option value="all">Todas</option>
        <option value="Nutrición">Nutrición</option>
        <option value="Dermocosmética">Dermocosmética</option>
        <option value="Pediatría">Pediatría</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="searchFilter">Búsqueda</label>
      <input id="searchFilter" type="search" placeholder="Nombre o SKU" />
    </div>
    <div class="filter-group">
      <label>Caducidad</label>
      <div class="toggle">
        <input id="expiryToggle" type="checkbox" />
        <span>Próximos 45 días</span>
      </div>
    </div>
    </section>

  <section id="summary" class="summary" aria-live="polite"></section>

  <main>
    <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Línea</th>
          <th>Estado</th>
          <th>Stock</th>
          <th>Acciones</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>
    </table>
    </div>
  </main>

  <div id="history-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="history-title">
      <div class="modal-header">
        <div>
          <h3 id="history-title">Historial de producto</h3>
          <div id="history-subtitle" class="modal-subtitle"></div>
        </div>
        <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">✕</button>
      </div>
      <div class="modal-body">
        <div id="history-loading" class="modal-loading">Cargando historial…</div>
        <div id="history-empty" class="modal-empty" hidden>Sin movimientos registrados.</div>
        <div id="history-table-wrap" class="table-wrap" hidden>
          <table aria-label="Historial de movimientos">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Unidad</th>
                <th>Usuario</th>
                <th>Nota</th>
              </tr>
            </thead>
            <tbody id="history-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="action-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="action-title">
      <div class="modal-header">
        <div>
          <h3 id="action-title">Acción</h3>
          <div id="action-subtitle" class="modal-subtitle"></div>
        </div>
        <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">✕</button>
      </div>
      <div class="modal-body">
        <form id="action-form" class="modal-grid">
          <div id="action-error" class="modal-error" hidden></div>
          <div class="modal-row">
            <div>
              <label for="action-qty">Cantidad</label>
              <input id="action-qty" name="cantidad" type="number" min="1" step="1" value="1" />
            </div>
            <div>
              <label id="action-max-label" for="action-qty">Disponible</label>
              <input id="action-max" type="text" value="-" disabled />
            </div>
          </div>
          <div>
            <label id="action-note-label" for="action-note">Nota</label>
            <textarea id="action-note" name="nota" placeholder=""></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="secondary" data-modal-close>Cancelar</button>
            <button id="action-submit" type="submit" class="primary">Confirmar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const products = [
      {{- range .Products }}
      {
        id: "{{js .ID}}",
        name: "{{js .Name}}",
        line: "{{js .Line}}",
        statusClass: "{{js .EstadoClass}}",
        statusLabel: "{{js .EstadoLabel}}",
        available: {{.Disponible}},
        units: [
          {{- range .Unidades }}
          {
            id: "{{js .ID}}",
            created: "{{js .CreadoEn}}",
            expires: "{{js .Caducidad}}",
            statusClass: "{{js .EstadoClass}}",
            statusLabel: "{{js .Estado}}",
            fifo: "{{js .FIFO}}"
          },
          {{- end }}
        ]
      },
      {{- end }}
    ];

    const statusFilter = document.getElementById("statusFilter");
    const lineFilter = document.getElementById("lineFilter");
    const searchFilter = document.getElementById("searchFilter");
    const expiryToggle = document.getElementById("expiryToggle");
    const productTable = document.getElementById("productTable");
    const summary = document.getElementById("summary");
    const downloadTemplateButton = document.getElementById("download-template");
    const uploadInput = document.getElementById("csv-upload");
    const processButton = document.getElementById("process-csv");
    const uploadStatus = document.getElementById("upload-status");
    const uploadPreviewBody = document.getElementById("upload-preview-body");
    const movementLog = document.getElementById("movement-log");
    const rangeStart = document.getElementById("range-start");
    const rangeEnd = document.getElementById("range-end");
    const exportInventoryAggregateButton = document.getElementById("export-inventory-aggregate");
    const exportInventoryUnitsButton = document.getElementById("export-inventory-units");
    const exportSalesButton = document.getElementById("export-sales");
    const exportChangesButton = document.getElementById("export-changes");

    const formatDate = (value) => new Date(value).toLocaleDateString("es-ES");
    const formatOptionalDate = (value) => {
      if (!value) return "-";
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) return "-";
      return parsed.toLocaleDateString("es-ES");
    };
    const formatDateISO = (value) => new Date(value).toISOString().slice(0, 10);
    const statusLabels = {
      available: "Disponible",
      sold: "Vendido",
      swapped: "Cambio",
      Disponible: "Disponible",
      Vendida: "Vendido",
      Vendido: "Vendido",
      Cambio: "Cambio"
    };
    const statusLabel = (status) => statusLabels[status] || status;

    const updateSummary = (visibleProducts) => {
      if (!summary) {
        console.warn("Resumen no disponible: falta el contenedor #summary.");
        return;
      }
      const totalProducts = visibleProducts.length;
      const totalUnits = visibleProducts.reduce((acc, product) => acc + product.available, 0);
      const expiringUnits = visibleProducts.reduce(
        (acc, product) => acc + product.units.filter((unit) => isExpiringSoon(unit.expires)).length,
        0
      );

      summary.innerHTML = `
        <div class="summary-card">
          <h3>Productos</h3>
          <span>${totalProducts}</span>
        </div>
        <div class="summary-card">
          <h3>Unidades</h3>
          <span>${totalUnits}</span>
        </div>
        <div class="summary-card">
          <h3>Por caducar</h3>
          <span>${expiringUnits}</span>
        </div>
      `;
    };

    const isExpiringSoon = (dateString) => {
      if (!dateString) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const expiry = new Date(dateString);
      if (Number.isNaN(expiry.getTime())) return false;
      expiry.setHours(0, 0, 0, 0);
      const diffDays = (expiry - today) / (1000 * 60 * 60 * 24);
      return diffDays >= 0 && diffDays <= 45;
    };

    const applyFilters = () => {
      if (!statusFilter || !lineFilter || !searchFilter || !expiryToggle) {
        console.warn("Filtros no disponibles: faltan controles de filtro en el DOM.");
        return;
      }
      const statusValue = statusFilter.value;
      const lineValue = lineFilter.value;
      const query = searchFilter.value.toLowerCase();
      const expiryOnly = expiryToggle.checked;

      const filtered = products.filter((product) => {
        const matchesStatus = statusValue === "all" || product.statusClass === statusValue;
        const matchesLine = lineValue === "all" || product.line === lineValue;
        const matchesSearch =
          product.name.toLowerCase().includes(query) || product.id.toLowerCase().includes(query);
        const matchesExpiry = !expiryOnly || product.units.some((unit) => isExpiringSoon(unit.expires));

        return matchesStatus && matchesLine && matchesSearch && matchesExpiry;
      });

      renderTable(filtered);
      updateSummary(filtered);
    };

    const renderTable = (items) => {
      if (!productTable) {
        console.warn("Tabla de productos no disponible: falta #productTable.");
        return;
      }
      productTable.innerHTML = "";

      items.forEach((product) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <div class="product-name" data-product="${product.id}">${product.name}</div>
            <div class="fifo-note">SKU ${product.id} · ${product.available} disponibles</div>
          </td>
          <td>${product.line}</td>
          <td><span class="status ${product.statusClass}">${statusLabel(product.statusLabel)}</span></td>
          <td><strong>${product.available}</strong></td>
          <td>
            <div class="actions">
              <input type="number" min="1" max="${Math.max(product.available, 1)}" value="1" data-qty="${product.id}" />
              <button class="primary" data-action="sell" data-product="${product.id}">Vender</button>
              <button class="secondary" data-action="swap" data-product="${product.id}">Cambio</button>
            </div>
          </td>
          <td>
            <div class="menu">
              <button class="ghost" data-menu="${product.id}">⋮</button>
              <div class="menu-panel" id="menu-${product.id}">
                <button type="button" data-menu-action="reserve" data-product="${product.id}">Reservar unidades</button>
                <button type="button" data-menu-action="damage" data-product="${product.id}">Registrar daño</button>
                <button type="button" data-menu-action="history" data-product="${product.id}">Ver historial</button>
              </div>
            </div>
          </td>
        `;

        productTable.appendChild(row);

        const unitsRow = document.createElement("tr");
        unitsRow.innerHTML = `
          <td colspan="6" class="units-panel" id="units-${product.id}" style="display: none;">
            <div class="units-header">
              <h4>Unidades</h4>
              <span class="fifo-note">Selección FIFO</span>
            </div>
            <table class="units-table" aria-label="Unidades del producto">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Ingreso</th>
                  <th>Caduca</th>
                  <th>Ubicación</th>
                  <th>Estado</th>
                  <th>FIFO</th>
                </tr>
              </thead>
              <tbody>
                ${product.units
                  .map((unit, index) => {
                    const fifoOrder = unit.fifo || (unit.statusClass === "available" ? index + 1 : "-");
                    return `
                      <tr>
                        <td>${unit.id}</td>
                        <td>${formatOptionalDate(unit.created)}</td>
                        <td>${formatOptionalDate(unit.expires)}</td>
                        <td>-</td>
                        <td>${statusLabel(unit.statusLabel)}</td>
                        <td><span class="unit-tag">${fifoOrder}</span></td>
                      </tr>
                    `;
                  })
                  .join("")}
              </tbody>
            </table>
          </td>
        </tr>
        `;

        productTable.appendChild(unitsRow);
      });
    };

    renderTable(products);
    updateSummary(products);
    if (statusFilter && lineFilter && searchFilter && expiryToggle) {
      [statusFilter, lineFilter, searchFilter, expiryToggle].forEach((input) =>
        input.addEventListener("change", applyFilters)
      );
      searchFilter.addEventListener("input", applyFilters);
    } else {
      console.warn("Listeners de filtros no registrados por controles faltantes.");
    }
  </script>

  <script>
    const historyModal = document.getElementById("history-modal");
    const historySubtitle = document.getElementById("history-subtitle");
    const historyLoading = document.getElementById("history-loading");
    const historyEmpty = document.getElementById("history-empty");
    const historyTableWrap = document.getElementById("history-table-wrap");
    const historyTbody = document.getElementById("history-tbody");

    const actionModal = document.getElementById("action-modal");
    const actionTitle = document.getElementById("action-title");
    const actionSubtitle = document.getElementById("action-subtitle");
    const actionForm = document.getElementById("action-form");
    const actionQty = document.getElementById("action-qty");
    const actionMax = document.getElementById("action-max");
    const actionError = document.getElementById("action-error");
    const actionNote = document.getElementById("action-note");
    const actionNoteLabel = document.getElementById("action-note-label");
    const actionSubmit = document.getElementById("action-submit");

    const openModal = (backdrop, subtitleText) => {
      if (!backdrop) return;
      backdrop.classList.add("open");
      backdrop.setAttribute("aria-hidden", "false");
      if (subtitleText && backdrop === historyModal && historySubtitle) historySubtitle.textContent = subtitleText;
      if (subtitleText && backdrop === actionModal && actionSubtitle) actionSubtitle.textContent = subtitleText;
      document.body.style.overflow = "hidden";
    };

    const closeModal = (backdrop) => {
      if (!backdrop) return;
      backdrop.classList.remove("open");
      backdrop.setAttribute("aria-hidden", "true");
      if (!document.querySelector(".modal-backdrop.open")) {
        document.body.style.overflow = "";
      }
    };

    const setActionError = (msg) => {
      if (!actionError) return;
      if (!msg) {
        actionError.hidden = true;
        actionError.textContent = "";
        return;
      }
      actionError.hidden = false;
      actionError.textContent = msg;
    };

    let actionContext = null;
    let openMenuContext = null;

    const positionMenuPanel = (button, panel) => {
      if (!button || !panel) return;
      const padding = 12;
      const gap = 8;

      // Ensure we can measure the panel size.
      const btnRect = button.getBoundingClientRect();
      const panelRect = panel.getBoundingClientRect();

      let top = btnRect.bottom + gap;
      // Flip upward if it would overflow the viewport.
      if (top + panelRect.height > window.innerHeight - padding) {
        top = btnRect.top - panelRect.height - gap;
      }
      top = Math.max(padding, Math.min(top, window.innerHeight - padding - panelRect.height));

      // Align panel's right edge to the button's right edge (like "right: 0" used to do).
      let left = btnRect.right - panelRect.width;
      left = Math.max(padding, Math.min(left, window.innerWidth - padding - panelRect.width));

      panel.style.left = `${Math.round(left)}px`;
      panel.style.top = `${Math.round(top)}px`;
    };

    const closeOpenMenuPanels = () => {
      document.querySelectorAll(".menu-panel.open").forEach((panel) => {
        panel.classList.remove("open");
        panel.style.left = "";
        panel.style.top = "";
      });
      openMenuContext = null;
    };

    const openActionModal = ({ title, subtitle, endpoint, productId, maxQty, defaultQty, noteLabel, notePlaceholder }) => {
      actionContext = { endpoint, productId, maxQty };
      if (actionTitle) actionTitle.textContent = title;
      if (actionNoteLabel) actionNoteLabel.textContent = noteLabel || "Nota";
      if (actionNote) actionNote.placeholder = notePlaceholder || "";
      if (actionNote) actionNote.value = "";
      if (actionMax) actionMax.value = maxQty >= 0 ? String(maxQty) : "-";
      if (actionQty) {
        actionQty.max = String(Math.max(1, maxQty));
        actionQty.value = String(Math.min(Math.max(1, defaultQty || 1), Math.max(1, maxQty)));
      }
      if (actionSubmit) actionSubmit.disabled = false;
      setActionError("");
      openModal(actionModal, subtitle);
      if (actionQty) actionQty.focus();
    };

    const showHistory = async (product) => {
      if (!product) return;
      openModal(historyModal, `${product.name} · SKU ${product.id}`);

      if (historyLoading) historyLoading.hidden = false;
      if (historyEmpty) {
        historyEmpty.hidden = true;
        historyEmpty.textContent = "Sin movimientos registrados.";
      }
      if (historyTableWrap) historyTableWrap.hidden = true;
      if (historyTbody) historyTbody.innerHTML = "";

      try {
        const resp = await fetch(`/productos/historial?${new URLSearchParams({ producto_id: product.id }).toString()}`);
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) {
          throw new Error(data.error || "No se pudo cargar el historial.");
        }

        const movimientos = Array.isArray(data.movimientos) ? data.movimientos : [];
        if (movimientos.length === 0) {
          if (historyEmpty) historyEmpty.hidden = false;
          return;
        }

        movimientos.forEach((m) => {
          if (!historyTbody) return;
          const tr = document.createElement("tr");

          const dateCell = document.createElement("td");
          const parsed = new Date(m.fecha);
          dateCell.textContent = Number.isNaN(parsed.getTime())
            ? String(m.fecha || "-")
            : parsed.toLocaleString("es-ES");

          const typeCell = document.createElement("td");
          const tag = document.createElement("span");
          const tipo = String(m.tipo || "movimiento");
          const labels = {
            venta: "Venta",
            reservar: "Reserva",
            dano: "Daño",
            cambio_salida: "Cambio"
          };
          tag.className = `move-tag ${tipo}`;
          tag.textContent = labels[tipo] || tipo;
          typeCell.appendChild(tag);

          const unitCell = document.createElement("td");
          unitCell.textContent = String(m.unidad_id || "-");

          const userCell = document.createElement("td");
          userCell.textContent = String(m.usuario || "-");

          const noteCell = document.createElement("td");
          noteCell.textContent = String(m.nota || "-");

          tr.appendChild(dateCell);
          tr.appendChild(typeCell);
          tr.appendChild(unitCell);
          tr.appendChild(userCell);
          tr.appendChild(noteCell);
          historyTbody.appendChild(tr);
        });

        if (historyTableWrap) historyTableWrap.hidden = false;
      } catch (err) {
        if (historyEmpty) {
          historyEmpty.hidden = false;
          historyEmpty.textContent = err?.message || "No se pudo cargar el historial.";
        }
      } finally {
        if (historyLoading) historyLoading.hidden = true;
      }
    };

    const postAction = async (endpoint, productId, qty, note) => {
      const body = new URLSearchParams({
        producto_id: productId,
        cantidad: String(qty),
        nota: note || ""
      });
      const resp = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.ok) {
        throw new Error(data.error || "No se pudo completar la acción.");
      }
    };

    if (actionForm) {
      actionForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!actionContext) return;

        const qty = parseInt(actionQty?.value || "0", 10);
        if (Number.isNaN(qty) || qty < 1 || qty > actionContext.maxQty) {
          setActionError("Cantidad inválida.");
          return;
        }

        const note = (actionNote?.value || "").trim();
        if (actionSubmit) actionSubmit.disabled = true;
        setActionError("");

        try {
          await postAction(actionContext.endpoint, actionContext.productId, qty, note);
          closeModal(actionModal);
          window.location.reload();
        } catch (err) {
          setActionError(err?.message || "No se pudo completar la acción.");
          if (actionSubmit) actionSubmit.disabled = false;
        }
      });
    }

    document.addEventListener("click", (event) => {
      const closeButton = event.target.closest("[data-modal-close]");
      if (closeButton) {
        const backdrop = closeButton.closest(".modal-backdrop");
        closeModal(backdrop);
        return;
      }

      const backdropClick = event.target.classList?.contains("modal-backdrop");
      if (backdropClick) {
        closeModal(event.target);
        return;
      }

      const menuButton = event.target.closest("button[data-menu]");
      if (menuButton) {
        const menuId = menuButton.dataset.menu;
        const panel = document.getElementById(`menu-${menuId}`);
        if (!panel) return;
        const willOpen = !panel.classList.contains("open");
        closeOpenMenuPanels();
        if (willOpen) {
          panel.classList.add("open");
          positionMenuPanel(menuButton, panel);
          openMenuContext = { button: menuButton, panel };
        }
        return;
      }

      if (!event.target.closest(".menu")) {
        closeOpenMenuPanels();
      }

      const menuAction = event.target.closest("button[data-menu-action]");
      if (menuAction) {
        const productId = menuAction.dataset.product;
        const action = menuAction.dataset.menuAction;
        const product = products.find((p) => p.id === productId);
        const qtyInput = document.querySelector(`input[data-qty="${productId}"]`);
        const maxQty = parseInt(qtyInput?.max || "0", 10);
        const defaultQty = parseInt(qtyInput?.value || "1", 10) || 1;

        // Close any open menu before running the action.
        closeOpenMenuPanels();

        if (action === "reserve") {
          if (!product || !Number.isFinite(maxQty) || maxQty < 1) {
            openActionModal({
              title: "Reservar unidades",
              subtitle: product ? `${product.name} · SKU ${productId}` : `SKU ${productId}`,
              endpoint: "/inventario/reservar",
              productId,
              maxQty: 0,
              defaultQty: 1,
              noteLabel: "Nota (opcional)",
              notePlaceholder: "Ej: apartadas para cliente Juan."
            });
            setActionError("No hay unidades disponibles para reservar.");
            if (actionSubmit) actionSubmit.disabled = true;
            return;
          }
          openActionModal({
            title: "Reservar unidades",
            subtitle: `${product.name} · SKU ${productId}`,
            endpoint: "/inventario/reservar",
            productId,
            maxQty,
            defaultQty,
            noteLabel: "Nota (opcional)",
            notePlaceholder: "Ej: apartadas para cliente Juan."
          });
          return;
        }
        if (action === "damage") {
          if (!product || !Number.isFinite(maxQty) || maxQty < 1) {
            openActionModal({
              title: "Registrar daño",
              subtitle: product ? `${product.name} · SKU ${productId}` : `SKU ${productId}`,
              endpoint: "/inventario/dano",
              productId,
              maxQty: 0,
              defaultQty: 1,
              noteLabel: "Descripción del daño (opcional)",
              notePlaceholder: "Ej: empaque roto, derrame, vencido, etc."
            });
            setActionError("No hay unidades disponibles para marcar como dañadas.");
            if (actionSubmit) actionSubmit.disabled = true;
            return;
          }
          openActionModal({
            title: "Registrar daño",
            subtitle: `${product.name} · SKU ${productId}`,
            endpoint: "/inventario/dano",
            productId,
            maxQty,
            defaultQty,
            noteLabel: "Descripción del daño (opcional)",
            notePlaceholder: "Ej: empaque roto, derrame, vencido, etc."
          });
          return;
        }
        if (action === "history") {
          showHistory(product);
          return;
        }
      }

      const actionButton = event.target.closest("button[data-action]");
      if (actionButton) {
        const productId = actionButton.dataset.product;
        const action = actionButton.dataset.action;
        const qtyInput = document.querySelector(`input[data-qty="${productId}"]`);
        const quantity = parseInt(qtyInput?.value || "1", 10);
        const maxQty = parseInt(qtyInput?.max || "0", 10);

        if (!productId || Number.isNaN(quantity) || quantity < 1 || (maxQty >= 1 && quantity > maxQty)) {
          return;
        }

        const params = new URLSearchParams({
          producto_id: productId,
          cantidad: String(quantity)
        });

        if (action === "sell") {
          window.location.href = `/venta/new?${params.toString()}`;
          return;
        }

        if (action === "swap") {
          window.location.href = `/cambio/new?${params.toString()}`;
          return;
        }
      }

      const productTrigger = event.target.closest(".product-name");
      if (!productTrigger) return;
      const productId = productTrigger.dataset.product;
      const panel = document.getElementById(`units-${productId}`);
      if (!panel) return;
      panel.style.display = panel.style.display === "none" ? "table-cell" : "none";
    });

    document.addEventListener("keydown", (event) => {
      if (event.key !== "Escape") return;
      document.querySelectorAll(".modal-backdrop.open").forEach((backdrop) => closeModal(backdrop));
    });

    const onViewportChange = () => {
      if (!openMenuContext) return;
      if (!openMenuContext.panel.classList.contains("open")) {
        openMenuContext = null;
        return;
      }
      positionMenuPanel(openMenuContext.button, openMenuContext.panel);
    };

    window.addEventListener("scroll", onViewportChange, { passive: true });
    window.addEventListener("resize", onViewportChange);
  </script>
</body>
</html>
