<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{.Title}}</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #1c1f2a;
      --muted: #5c647c;
      --primary: #2c6bed;
      --success: #1aa36f;
      --warning: #f5a524;
      --danger: #e5484d;
      --border: #d9dfea;
    }

    * {
      box-sizing: border-box;
      font-family: "Inter", "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 24px 32px 8px;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
    }

    header p {
      margin: 8px 0 0;
      color: var(--muted);
    }

    .filters {
      margin: 16px 32px;
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      border: 1px solid var(--border);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }

    select,
    input[type="search"],
    input[type="number"] {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .summary {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin: 0 32px 16px;
    }

    .import-panel {
      margin: 0 32px 24px;
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 16px;
      display: grid;
      gap: 16px;
    }

    .import-panel h2 {
      margin: 0;
      font-size: 18px;
    }

    .import-panel p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .import-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .csv-columns {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      font-size: 13px;
      color: var(--muted);
    }

    .csv-columns span {
      background: #f4f6fb;
      border-radius: 8px;
      padding: 6px 10px;
      border: 1px dashed var(--border);
    }

    .example-list {
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 13px;
    }

    .example-list code {
      color: #2a335a;
      background: #eef1f8;
      padding: 2px 6px;
      border-radius: 6px;
    }

    .summary-card {
      background: var(--card);
      border-radius: 12px;
      padding: 12px 16px;
      border: 1px solid var(--border);
      flex: 1;
      min-width: 180px;
    }

    .summary-card h3 {
      margin: 0;
      font-size: 14px;
      color: var(--muted);
    }

    .summary-card span {
      font-size: 20px;
      font-weight: 600;
    }

    .flash {
      margin-top: 16px;
      background: #e9f7f1;
      color: #1a6b4b;
      border: 1px solid #bde4d2;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
    }

    main {
      padding: 0 32px 32px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    thead {
      background: #eef1f8;
      text-align: left;
    }

    th,
    td {
      padding: 12px 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .status {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status.available {
      background: #e9f7f1;
      color: var(--success);
    }

    .status.sold {
      background: #ffeef0;
      color: var(--danger);
    }

    .status.swapped {
      background: #fff4e1;
      color: var(--warning);
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .actions input {
      width: 72px;
    }

    button {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    button.primary {
      background: var(--primary);
      color: white;
    }

    button.secondary {
      background: #e7ebf6;
      color: #2a335a;
    }

    button.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .menu {
      position: relative;
    }

    .menu-panel {
      position: absolute;
      right: 0;
      top: 40px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
      min-width: 180px;
      display: none;
      z-index: 5;
    }

    .menu-panel.open {
      display: block;
    }

    .menu-panel button {
      width: 100%;
      text-align: left;
      padding: 10px 14px;
      border-radius: 0;
      background: transparent;
    }

    .menu-panel button:hover {
      background: #f1f4fb;
    }

    .product-name {
      font-weight: 600;
      color: #25304d;
      cursor: pointer;
    }

    .units-panel {
      background: #f9fafc;
      padding: 12px 16px 20px;
    }

    .units-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .units-header h4 {
      margin: 0;
    }

    .fifo-note {
      font-size: 12px;
      color: var(--muted);
    }

    .units-table th,
    .units-table td {
      font-size: 12px;
      padding: 8px 10px;
    }

    .unit-tag {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e7efff;
      color: #2054c6;
    }
  </style>
</head>
<body>
  <header>
    <h1>{{.Title}}</h1>
    <p>{{.Subtitle}}</p>
    {{if .Flash}}
      <div class="flash">{{.Flash}}</div>
    {{end}}
  </header>

  <section class="filters">
    <div class="filter-group">
      <label for="statusFilter">Estado</label>
      <select id="statusFilter">
        <option value="all">Todos</option>
        <option value="available">Available</option>
        <option value="sold">Sold</option>
        <option value="swapped">Swapped</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="lineFilter">Línea</label>
      <select id="lineFilter">
        <option value="all">Todas</option>
        <option value="Nutrición">Nutrición</option>
        <option value="Dermocosmética">Dermocosmética</option>
        <option value="Pediatría">Pediatría</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="searchFilter">Búsqueda</label>
      <input id="searchFilter" type="search" placeholder="Nombre o SKU" />
    </div>
    <div class="filter-group">
      <label>Caducidad próxima</label>
      <div class="toggle">
        <input id="expiryToggle" type="checkbox" />
        <span>Mostrar próximos 45 días</span>
      </div>
    </div>
  </section>

  <section class="summary" id="summary"></section>

  <section class="import-panel" aria-labelledby="csv-mvp-title">
    <div>
      <h2 id="csv-mvp-title">Plantilla CSV MVP para carga masiva</h2>
      <p>Descarga la plantilla con las columnas mínimas para registrar productos y crear unidades DISPONIBLE.</p>
    </div>
    <div class="import-actions">
      <button class="primary" id="download-template">Descargar plantilla CSV</button>
      <p>Regla de importación: por cada fila se crea o encuentra el producto por <strong>línea + nombre</strong> (o por SKU si tu proceso lo genera) y se crean <strong>N unidades DISPONIBLE</strong> según el campo cantidad.</p>
    </div>
    <div>
      <p>Columnas requeridas y opcionales:</p>
      <div class="csv-columns">
        <span>linea</span>
        <span>nombre</span>
        <span>precio_base_venta</span>
        <span>precio_consultora</span>
        <span>caduca (true/false)</span>
        <span>fecha_caducidad (YYYY-MM-DD, opcional)</span>
        <span>anotaciones (opcional)</span>
        <span>cantidad (entero &gt; 0)</span>
      </div>
    </div>
    <div>
      <p>Ejemplos válidos:</p>
      <ul class="example-list">
        <li><code>Nutrición,Proteína Balance 500g,120000,98000,true,2025-01-12,Lote inicial,5</code></li>
        <li><code>Dermocosmética,Crema Regeneradora,89000,70000,false,,Promoción abril,12</code></li>
      </ul>
    </div>
  </section>

  <main>
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Línea</th>
          <th>Estado</th>
          <th>Stock disponible</th>
          <th>Acciones rápidas</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>
    </table>
  </main>

  <script>
    const products = [
      {
        id: "P-001",
        name: "Proteína Balance 500g",
        line: "Nutrición",
        status: "available",
        units: [
          { id: "U-001", received: "2024-05-10", expires: "2024-11-10", location: "A-01", status: "available" },
          { id: "U-002", received: "2024-06-02", expires: "2024-12-02", location: "A-01", status: "available" },
          { id: "U-003", received: "2024-07-12", expires: "2025-01-12", location: "A-02", status: "available" }
        ]
      },
      {
        id: "P-002",
        name: "Crema Regeneradora",
        line: "Dermocosmética",
        status: "available",
        units: [
          { id: "U-101", received: "2024-04-01", expires: "2024-09-08", location: "B-11", status: "available" },
          { id: "U-102", received: "2024-04-18", expires: "2024-09-25", location: "B-11", status: "available" },
          { id: "U-103", received: "2024-05-05", expires: "2024-11-02", location: "B-12", status: "available" },
          { id: "U-104", received: "2024-05-20", expires: "2024-12-09", location: "B-13", status: "available" }
        ]
      },
      {
        id: "P-003",
        name: "Leche Pediátrica Premium",
        line: "Pediatría",
        status: "swapped",
        units: [
          { id: "U-201", received: "2024-03-15", expires: "2024-08-20", location: "C-02", status: "available" },
          { id: "U-202", received: "2024-04-02", expires: "2024-10-18", location: "C-03", status: "swapped" }
        ]
      },
      {
        id: "P-004",
        name: "Shampoo Suave",
        line: "Dermocosmética",
        status: "sold",
        units: [
          { id: "U-301", received: "2024-01-22", expires: "2024-07-01", location: "B-21", status: "sold" },
          { id: "U-302", received: "2024-02-15", expires: "2024-08-18", location: "B-22", status: "sold" }
        ]
      }
    ];

    const statusFilter = document.getElementById("statusFilter");
    const lineFilter = document.getElementById("lineFilter");
    const searchFilter = document.getElementById("searchFilter");
    const expiryToggle = document.getElementById("expiryToggle");
    const productTable = document.getElementById("productTable");
    const summary = document.getElementById("summary");
    const downloadTemplateButton = document.getElementById("download-template");

    const formatDate = (value) => new Date(value).toLocaleDateString("es-ES");

    const updateSummary = (visibleProducts) => {
      const totalProducts = visibleProducts.length;
      const totalUnits = visibleProducts.reduce((acc, product) => acc + product.units.filter((unit) => unit.status === "available").length, 0);
      const expiringUnits = visibleProducts.reduce(
        (acc, product) => acc + product.units.filter((unit) => isExpiringSoon(unit.expires)).length,
        0
      );

      summary.innerHTML = `
        <div class="summary-card">
          <h3>Productos visibles</h3>
          <span>${totalProducts}</span>
        </div>
        <div class="summary-card">
          <h3>Unidades disponibles</h3>
          <span>${totalUnits}</span>
        </div>
        <div class="summary-card">
          <h3>Próximos a caducar</h3>
          <span>${expiringUnits}</span>
        </div>
      `;
    };

    const isExpiringSoon = (dateString) => {
      const today = new Date();
      const expiry = new Date(dateString);
      const diffDays = (expiry - today) / (1000 * 60 * 60 * 24);
      return diffDays <= 45;
    };

    const applyFilters = () => {
      const statusValue = statusFilter.value;
      const lineValue = lineFilter.value;
      const query = searchFilter.value.toLowerCase();
      const expiryOnly = expiryToggle.checked;

      const filtered = products.filter((product) => {
        const matchesStatus = statusValue === "all" || product.status === statusValue;
        const matchesLine = lineValue === "all" || product.line === lineValue;
        const matchesSearch =
          product.name.toLowerCase().includes(query) || product.id.toLowerCase().includes(query);
        const matchesExpiry = !expiryOnly || product.units.some((unit) => isExpiringSoon(unit.expires));

        return matchesStatus && matchesLine && matchesSearch && matchesExpiry;
      });

      renderTable(filtered);
      updateSummary(filtered);
    };

    const renderTable = (items) => {
      productTable.innerHTML = "";

      items.forEach((product) => {
        const availableUnits = product.units.filter((unit) => unit.status === "available");
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <div class="product-name" data-product="${product.id}">${product.name}</div>
            <div class="fifo-note">SKU ${product.id} · FIFO: ${availableUnits.length} unidades disponibles</div>
          </td>
          <td>${product.line}</td>
          <td><span class="status ${product.status}">${product.status}</span></td>
          <td><strong>${availableUnits.length}</strong></td>
          <td>
            <div class="actions">
              <input type="number" min="1" max="${availableUnits.length}" value="1" data-qty="${product.id}" />
              <button class="primary" data-action="sell" data-product="${product.id}">Vender</button>
              <button class="secondary" data-action="swap" data-product="${product.id}">Cambio</button>
            </div>
          </td>
          <td>
            <div class="menu">
              <button class="ghost" data-menu="${product.id}">⋮</button>
              <div class="menu-panel" id="menu-${product.id}">
                <button>Reservar unidades</button>
                <button>Registrar daño</button>
                <button>Ver historial</button>
              </div>
            </div>
          </td>
        `;

        productTable.appendChild(row);

        const unitsRow = document.createElement("tr");
        unitsRow.innerHTML = `
          <td colspan="6" class="units-panel" id="units-${product.id}" style="display: none;">
            <div class="units-header">
              <h4>Unidades del producto</h4>
              <span class="fifo-note">Auditoría por lote · Selección FIFO al vender o cambiar</span>
            </div>
            <table class="units-table" aria-label="Unidades de ${product.name}">
              <thead>
                <tr>
                  <th>ID unidad</th>
                  <th>Ingreso</th>
                  <th>Caducidad</th>
                  <th>Ubicación</th>
                  <th>Estado</th>
                  <th>FIFO</th>
                </tr>
              </thead>
              <tbody>
                ${product.units
                  .map((unit, index) => {
                    const fifoOrder = unit.status === "available" ? index + 1 : "-";
                    return `
                      <tr>
                        <td>${unit.id}</td>
                        <td>${formatDate(unit.received)}</td>
                        <td>${formatDate(unit.expires)}</td>
                        <td>${unit.location}</td>
                        <td>${unit.status}</td>
                        <td><span class="unit-tag">${fifoOrder}</span></td>
                      </tr>
                    `;
                  })
                  .join("")}
              </tbody>
            </table>
          </td>
        `;

        productTable.appendChild(unitsRow);
      });
    };

    const applyFifoAction = (productId, action, quantity) => {
      const product = products.find((item) => item.id === productId);
      if (!product) return;

      const available = product.units
        .filter((unit) => unit.status === "available")
        .sort((a, b) => new Date(a.received) - new Date(b.received));

      const selected = available.slice(0, quantity);
      selected.forEach((unit) => {
        unit.status = action === "sell" ? "sold" : "swapped";
      });

      product.status = product.units.every((unit) => unit.status === "sold")
        ? "sold"
        : product.units.every((unit) => unit.status === "swapped")
          ? "swapped"
          : "available";
    };

    document.addEventListener("click", (event) => {
      const menuButton = event.target.closest("button[data-menu]");
      const productTrigger = event.target.closest(".product-name");
      const actionButton = event.target.closest("button[data-action]");

      if (menuButton) {
        const menuId = menuButton.dataset.menu;
        const panel = document.getElementById(`menu-${menuId}`);
        panel.classList.toggle("open");
      } else {
        document.querySelectorAll(".menu-panel").forEach((panel) => panel.classList.remove("open"));
      }

      if (productTrigger) {
        const productId = productTrigger.dataset.product;
        const panel = document.getElementById(`units-${productId}`);
        panel.style.display = panel.style.display === "none" ? "table-cell" : "none";
      }

      if (actionButton) {
        const productId = actionButton.dataset.product;
        const action = actionButton.dataset.action;
        const qtyInput = document.querySelector(`input[data-qty="${productId}"]`);
        const quantity = parseInt(qtyInput.value, 10);

        if (!Number.isNaN(quantity) && quantity > 0) {
          if (action === "sell") {
            const params = new URLSearchParams({
              producto_id: productId,
              cantidad: quantity.toString()
            });
            window.location.href = `/venta/new?${params.toString()}`;
            return;
          }
          if (action === "swap") {
            const params = new URLSearchParams({
              producto_id: productId,
              cantidad: quantity.toString()
            });
            window.location.href = `/cambio/new?${params.toString()}`;
            return;
          }
          applyFifoAction(productId, action, quantity);
          applyFilters();
        }
      }
    });

    [statusFilter, lineFilter, searchFilter, expiryToggle].forEach((input) => {
      input.addEventListener("input", applyFilters);
      input.addEventListener("change", applyFilters);
    });

    applyFilters();

    downloadTemplateButton.addEventListener("click", () => {
      const header = [
        "linea",
        "nombre",
        "precio_base_venta",
        "precio_consultora",
        "caduca",
        "fecha_caducidad",
        "anotaciones",
        "cantidad"
      ];
      const rows = [
        [
          "Nutrición",
          "Proteína Balance 500g",
          "120000",
          "98000",
          "true",
          "2025-01-12",
          "Lote inicial",
          "5"
        ],
        ["Dermocosmética", "Crema Regeneradora", "89000", "70000", "false", "", "Promoción abril", "12"]
      ];

      const escapeCSV = (value) => {
        const stringValue = String(value);
        if (/[",\n]/.test(stringValue)) {
          return `"${stringValue.replace(/"/g, '""')}"`;
        }
        return stringValue;
      };

      const csvContent = [header, ...rows]
        .map((row) => row.map(escapeCSV).join(","))
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "plantilla_productos_mvp.csv";
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
